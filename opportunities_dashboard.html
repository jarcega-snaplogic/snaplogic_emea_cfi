<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SnapLogic Opportunities Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }
        
        .dashboard-container {
            display: flex;
            gap: 20px;
            width: 100%;
            margin: 0;
            height: calc(100vh - 40px);
        }
        
        .table-section {
            flex: 2;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .se-aggregation {
            flex: 1;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            overflow-y: auto;
        }
        
        .header {
            background: #1f4788;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .filters-container {
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 150px;
        }
        
        .filter-group label {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 3px;
            color: #555;
        }
        
        .filter-group input, .filter-group select {
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .table-container {
            flex: 1;
            overflow: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        th, td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
            white-space: nowrap;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        .editable {
            background: #fff3cd;
            cursor: pointer;
            min-width: 150px;
        }
        
        .editable:hover {
            background: #ffeaa7;
        }
        
        .se-card {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #1f4788;
        }
        
        .se-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 10px;
            color: #1f4788;
        }
        
        .revenue-breakdown {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        
        .revenue-item {
            background: white;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            border: 1px solid #dee2e6;
        }
        
        .revenue-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
        }
        
        .revenue-amount {
            font-size: 14px;
            font-weight: bold;
            color: #28a745;
        }
        
        .total-revenue {
            font-size: 18px;
            font-weight: bold;
            color: #1f4788;
            text-align: center;
            margin-bottom: 10px;
        }
        
        .version {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(31, 71, 136, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }
        
        .amount-cell {
            text-align: right;
            font-weight: 500;
        }
        
        .positive {
            color: #28a745;
        }
        
        .se-editor {
            border: 1px solid #ccc;
            background: white;
            width: 100%;
            padding: 4px;
            border-radius: 3px;
        }
        
        .se-editor:focus {
            outline: 2px solid #007bff;
            border-color: #007bff;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="table-section">
            <div class="header">
                <h1>SnapLogic Opportunities Dashboard</h1>
                <div id="record-count">Loading...</div>
            </div>
            
            <div class="filters-container">
                <div class="filter-group">
                    <label>Account Name</label>
                    <input type="text" id="filter-account" placeholder="Filter by account...">
                </div>
                <div class="filter-group">
                    <label>Owner</label>
                    <input type="text" id="filter-owner" placeholder="Filter by owner...">
                </div>
                <div class="filter-group">
                    <label>Region</label>
                    <select id="filter-region">
                        <option value="">All Regions</option>
                        <option value="EMEA">EMEA (All)</option>
                        <option value="AMER">AMER (All)</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Type</label>
                    <select id="filter-type">
                        <option value="">All Types</option>
                        <option value="ACV">ACV (New + Add-on)</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Stage</label>
                    <select id="filter-stage">
                        <option value="">All Stages</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Solutions Engineer</label>
                    <input type="text" id="filter-se" placeholder="Filter by SE...">
                </div>
            </div>
            
            <div class="table-container">
                <table id="opportunities-table">
                    <thead>
                        <tr>
                            <th>Account</th>
                            <th>Opportunity</th>
                            <th>Owner</th>
                            <th>Amount</th>
                            <th>Close Date</th>
                            <th>Region</th>
                            <th>Stage</th>
                            <th>Type</th>
                            <th>Solutions Engineer</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <tr>
                            <td colspan="9" class="loading">Loading opportunities...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="se-aggregation">
            <h2 style="margin-bottom: 20px; color: #1f4788;">Solutions Engineers Revenue</h2>
            <div id="se-summary">
                <div class="loading">Loading SE data...</div>
            </div>
        </div>
    </div>
    
    <div class="version">v1.2.2</div>
    
    <script>
        let opportunitiesData = [];
        let filteredData = [];
        let allSolutionsEngineers = [];
        
        // Load and initialize data
        async function loadData() {
            try {
                const response = await fetch('opportunities.json');
                opportunitiesData = await response.json();
                filteredData = [...opportunitiesData];
                
                // Cache unique Solutions Engineers on load
                allSolutionsEngineers = [...new Set(opportunitiesData
                    .map(o => o.Solutions_Engineer)
                    .filter(Boolean))]
                    .sort();
                
                initializeFilters();
                renderTable();
                updateSEAggregation();
                updateRecordCount();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('table-body').innerHTML = 
                    '<tr><td colspan="9" style="color: red;">Error loading data</td></tr>';
            }
        }
        
        // Initialize filter dropdowns
        function initializeFilters() {
            const regions = [...new Set(opportunitiesData.map(o => o.region).filter(Boolean))].sort();
            const types = [...new Set(opportunitiesData.map(o => o.opportunity_type).filter(Boolean))].sort();
            const stages = [...new Set(opportunitiesData.map(o => o.stage).filter(Boolean))].sort();
            
            populateSelect('filter-region', regions);
            populateSelect('filter-type', types);
            populateSelect('filter-stage', stages);
            
            // Add event listeners
            document.getElementById('filter-account').addEventListener('input', applyFilters);
            document.getElementById('filter-owner').addEventListener('input', applyFilters);
            document.getElementById('filter-region').addEventListener('change', applyFilters);
            document.getElementById('filter-type').addEventListener('change', applyFilters);
            document.getElementById('filter-stage').addEventListener('change', applyFilters);
            document.getElementById('filter-se').addEventListener('input', applyFilters);
        }
        
        function populateSelect(selectId, options) {
            const select = document.getElementById(selectId);
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });
        }
        
        // Apply filters
        function applyFilters() {
            const filters = {
                account: document.getElementById('filter-account').value.toLowerCase(),
                owner: document.getElementById('filter-owner').value.toLowerCase(),
                region: document.getElementById('filter-region').value,
                type: document.getElementById('filter-type').value,
                stage: document.getElementById('filter-stage').value,
                se: document.getElementById('filter-se').value.toLowerCase()
            };
            
            filteredData = opportunitiesData.filter(opp => {
                let regionMatch = true;
                if (filters.region) {
                    if (filters.region === 'EMEA') {
                        regionMatch = (opp.region || '').includes('EMEA');
                    } else if (filters.region === 'AMER') {
                        regionMatch = (opp.region || '').includes('AMER');
                    } else {
                        regionMatch = opp.region === filters.region;
                    }
                }
                
                let typeMatch = true;
                if (filters.type) {
                    if (filters.type === 'ACV') {
                        typeMatch = (opp.opportunity_type === 'New Business' || opp.opportunity_type === 'Add-on Business');
                    } else {
                        typeMatch = opp.opportunity_type === filters.type;
                    }
                }
                
                return (!filters.account || (opp.account_name || '').toLowerCase().includes(filters.account)) &&
                       (!filters.owner || (opp.owner_name || '').toLowerCase().includes(filters.owner)) &&
                       regionMatch &&
                       typeMatch &&
                       (!filters.stage || opp.stage === filters.stage) &&
                       (!filters.se || (opp.Solutions_Engineer || '').toLowerCase().includes(filters.se));
            });
            
            renderTable();
            updateSEAggregation();
            updateRecordCount();
        }
        
        // Render table
        function renderTable() {
            const tbody = document.getElementById('table-body');
            
            if (filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #666;">No opportunities match your filters</td></tr>';
                return;
            }
            
            tbody.innerHTML = filteredData.map(opp => `
                <tr>
                    <td>${opp.account_name || '-'}</td>
                    <td>${opp.opportunity_name || '-'}</td>
                    <td>${opp.owner_name || '-'}</td>
                    <td class="amount-cell positive">$${(opp.amount || 0).toLocaleString()}</td>
                    <td>${opp.close_date || '-'}</td>
                    <td>${opp.region || '-'}</td>
                    <td>${opp.stage || '-'}</td>
                    <td>${opp.opportunity_type || '-'}</td>
                    <td class="editable" onclick="editSE('${opp.opportunity_id}', this)">
                        ${opp.Solutions_Engineer || 'Unassigned'}
                    </td>
                </tr>
            `).join('');
        }
        
        // Edit Solutions Engineer
        function editSE(oppId, cell) {
            const currentValue = cell.textContent.trim();
            const currentSE = currentValue === 'Unassigned' ? '' : currentValue;
            
            // Create select with cached SEs
            const select = document.createElement('select');
            select.className = 'se-editor';
            
            // Add Unassigned option
            select.innerHTML = '<option value="">Unassigned</option>';
            
            // Add all cached SEs
            allSolutionsEngineers.forEach(se => {
                const option = document.createElement('option');
                option.value = se;
                option.textContent = se;
                if (se === currentSE) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
            
            // Replace cell content with select
            cell.innerHTML = '';
            cell.appendChild(select);
            
            // Simple event handling - just save on change
            select.addEventListener('change', function() {
                const newValue = this.value;
                const displayValue = newValue || 'Unassigned';
                
                // Update data
                const opp = opportunitiesData.find(o => o.opportunity_id === oppId);
                if (opp) {
                    opp.Solutions_Engineer = newValue || null;
                }
                
                // Update cell display
                cell.textContent = displayValue;
                updateSEAggregation();
            });
            
            // Don't auto-focus to avoid flickering
        }
        
        // Update SE aggregation
        function updateSEAggregation() {
            const seData = {};
            
            filteredData.forEach(opp => {
                const se = opp.Solutions_Engineer || 'Unassigned';
                if (!seData[se]) {
                    seData[se] = {
                        'Add-on Business': 0,
                        'New Business': 0,
                        'Renewal': 0,
                        'Pro Serv': 0,
                        total: 0
                    };
                }
                
                const amount = opp.amount || 0;
                const type = opp.opportunity_type || 'Other';
                
                if (seData[se][type] !== undefined) {
                    seData[se][type] += amount;
                }
                seData[se].total += amount;
            });
            
            // Sort by total revenue
            const sortedSEs = Object.entries(seData)
                .sort(([,a], [,b]) => b.total - a.total);
            
            const summaryDiv = document.getElementById('se-summary');
            summaryDiv.innerHTML = sortedSEs.map(([se, data]) => `
                <div class="se-card">
                    <div class="se-name">${se}</div>
                    <div class="total-revenue">$${data.total.toLocaleString()}</div>
                    <div class="revenue-breakdown">
                        <div class="revenue-item">
                            <div class="revenue-label">ACV - Add-on</div>
                            <div class="revenue-amount">$${data['Add-on Business'].toLocaleString()}</div>
                        </div>
                        <div class="revenue-item">
                            <div class="revenue-label">ACV - New</div>
                            <div class="revenue-amount">$${data['New Business'].toLocaleString()}</div>
                        </div>
                        <div class="revenue-item">
                            <div class="revenue-label">Renewal</div>
                            <div class="revenue-amount">$${data['Renewal'].toLocaleString()}</div>
                        </div>
                        <div class="revenue-item">
                            <div class="revenue-label">Pro Serv</div>
                            <div class="revenue-amount">$${data['Pro Serv'].toLocaleString()}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Update record count
        function updateRecordCount() {
            const total = opportunitiesData.length;
            const filtered = filteredData.length;
            const totalRevenue = filteredData.reduce((sum, opp) => sum + (opp.amount || 0), 0);
            
            document.getElementById('record-count').innerHTML = 
                `${filtered} of ${total} opportunities | Total: $${totalRevenue.toLocaleString()}`;
        }
        
        // Initialize on load
        window.addEventListener('load', loadData);
    </script>
</body>
</html>